{% extends 'base.html' %}
{% load usuarios_tags %}

{% block title %}{{ job.title }} - Kunfido{% endblock %}

{% block extra_css %}
<style>
    .job-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    
    .badge-open {
        background-color: #28a745;
    }
    
    .badge-progress {
        background-color: #007bff;
    }
    
    .badge-closed {
        background-color: #6c757d;
    }
    
    .info-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        height: 100%;
    }
    
    .bid-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border-left: 4px solid #e0e0e0;
    }
    
    .bid-card:hover {
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
        border-left-color: var(--primary-color);
    }
    
    .bid-card.winning-bid {
        border-left-color: #28a745;
        background: linear-gradient(to right, #f0fff4 0%, white 100%);
    }
    
    .professional-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .vote-badge {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #333;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .proposal-form {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    
    .stat-box {
        text-align: center;
        padding: 1rem;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>
{% endblock %}

{% block content %}
<div class="container main-content">
    <!-- Header de la Oferta -->
    <div class="job-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="d-flex align-items-center mb-2">
                        {% if job.status == 'OPEN' %}
                            <span class="badge badge-open me-2">
                                <i class="bi bi-unlock-fill"></i> Abierto
                            </span>
                        {% elif job.status == 'IN_PROGRESS' %}
                            <span class="badge badge-progress me-2">
                                <i class="bi bi-hourglass-split"></i> En Progreso
                            </span>
                        {% else %}
                            <span class="badge badge-closed me-2">
                                <i class="bi bi-lock-fill"></i> Cerrado
                            </span>
                        {% endif %}
                        
                        {% if job.is_consorcio %}
                            <span class="badge bg-light text-dark">
                                <i class="bi bi-people-fill"></i> Consorcio
                            </span>
                        {% endif %}
                        
                        {% if job.is_delayed %}
                            <span class="badge bg-danger ms-2">
                                <i class="bi bi-exclamation-triangle-fill"></i> Atrasado
                            </span>
                        {% endif %}
                    </div>
                    
                    <h1 class="display-5 fw-bold mb-3">{{ job.title }}</h1>
                    
                    <div class="d-flex align-items-center">
                        <i class="bi bi-person-circle me-2 fs-5"></i>
                        <span>Publicado por <strong>{{ job.creator.nombre_completo }}</strong></span>
                        <span class="mx-3">•</span>
                        <i class="bi bi-clock me-1"></i>
                        <span>{{ job.created_at|date:"d/m/Y" }}</span>
                    </div>
                </div>
                
                <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                    <div class="stat-box bg-white bg-opacity-10 rounded p-3">
                        <div class="stat-number">${{ job.budget_base_ars|floatformat:0 }}</div>
                        <div>Presupuesto Base (ARS)</div>
                        <small class="opacity-75">≈ {{ job.budget_base_usdc }} USDC</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Columna Principal -->
        <div class="col-lg-8 mb-4">
            <!-- Alerta de Atraso (si aplica) -->
            {% if job.is_delayed and job.status == 'IN_PROGRESS' %}
            <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
                <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-2">Trabajo con Atraso Detectado</h5>
                    <p class="mb-2">
                        Este trabajo tiene <strong>{{ job.get_days_delayed }} día{{ job.get_days_delayed|pluralize }}</strong> de atraso 
                        respecto a la fecha esperada de finalización.
                    </p>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <small>
                            <i class="bi bi-calendar-x"></i> 
                            Fecha esperada: {{ job.expected_completion_date|date:"d/m/Y H:i" }}
                        </small>
                        {% if is_oficio %}
                            <a href="{% url 'submit_delay_justification' job.id %}" class="btn btn-warning btn-sm">
                                <i class="bi bi-shield-exclamation"></i> Ejercer Derecho a Réplica
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Descripción del Trabajo -->
            <div class="info-card mb-4">
                <h3 class="mb-3">
                    <i class="bi bi-file-text text-primary"></i> Descripción del Trabajo
                </h3>
                <p class="text-muted" style="white-space: pre-wrap;">{{ job.description }}</p>
            </div>
            
            <!-- Lista de Propuestas/Bids -->
            <div class="info-card">
                <h3 class="mb-4">
                    <i class="bi bi-chat-left-dots text-primary"></i> 
                    Propuestas Recibidas 
                    <span class="badge bg-primary rounded-pill">{{ bids.count }}</span>
                </h3>
                
                {% if bids %}
                    {% for bid in bids %}
                    <div class="bid-card {% if bid.is_winner %}winning-bid{% endif %}">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="professional-avatar">
                                    {{ bid.professional.user.first_name|first|default:"U"|upper }}{{ bid.professional.user.last_name|first|default:""|upper }}
                                </div>
                            </div>
                            
                            <div class="col">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h5 class="mb-1">
                                            {{ bid.professional.nombre_completo }}
                                            {% if bid.is_winner %}
                                                <span class="badge bg-success ms-2">
                                                    <i class="bi bi-trophy-fill"></i> Propuesta Aceptada
                                                </span>
                                            {% endif %}
                                        </h5>
                                        <small class="text-muted">
                                            <i class="bi bi-star-fill text-warning"></i> 
                                            {{ bid.professional.puntuacion|floatformat:1 }} / 5.0
                                        </small>
                                    </div>
                                    
                                    <div class="text-end">
                                        <div class="fw-bold text-success fs-5">
                                            ${{ bid.amount_ars|floatformat:0 }} ARS
                                        </div>
                                        <small class="text-muted">≈ {{ bid.amount_usdc }} USDC</small>
                                    </div>
                                </div>
                                
                                <p class="text-muted mb-3">{{ bid.pitch_text }}</p>
                                
                                <div class="row g-3">
                                    <div class="col-auto">
                                        <small class="text-muted">
                                            <i class="bi bi-calendar-check"></i> 
                                            {{ bid.estimated_days }} día{{ bid.estimated_days|pluralize }}
                                        </small>
                                    </div>
                                    
                                    <div class="col-auto">
                                        <small class="text-muted">
                                            <i class="bi bi-clock-history"></i> 
                                            {{ bid.created_at|timesince }} atrás
                                        </small>
                                    </div>
                                    
                                    {% if job.is_consorcio %}
                                    <div class="col-auto">
                                        <span class="vote-badge">
                                            <i class="bi bi-hand-thumbs-up-fill"></i> 
                                            {{ bid.total_votes }} voto{{ bid.total_votes|pluralize }}
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Botón Aceptar Propuesta (Solo para el dueño) -->
                                {% if is_owner and job.status == 'OPEN' and not bid.is_winner %}
                                <div class="mt-3">
                                    <form method="post" action="{% url 'accept_bid' bid.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-gradient" 
                                                onclick="return confirm('¿Estás seguro de aceptar esta propuesta?')">
                                            <i class="bi bi-check-circle-fill"></i> Aceptar esta Propuesta
                                        </button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <p class="text-muted mt-3">Aún no hay propuestas para esta oferta</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Justificaciones de Atraso Pendientes (Solo para el cliente) -->
            {% if is_owner and pending_delays %}
            <div class="info-card mt-4">
                <h3 class="mb-4">
                    <i class="bi bi-exclamation-circle text-warning"></i> 
                    Justificaciones Pendientes de Revisión
                    <span class="badge bg-warning text-dark rounded-pill">{{ pending_delays.count }}</span>
                </h3>
                
                {% for delay in pending_delays %}
                <div class="alert alert-warning d-flex align-items-start mb-3">
                    <i class="bi bi-chat-left-text fs-3 me-3"></i>
                    <div class="flex-grow-1">
                        <h5 class="mb-2">{{ delay.bid.professional.nombre_completo }}</h5>
                        <p class="mb-2">{{ delay.reason|truncatewords:30 }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-exclamation-triangle"></i> {{ delay.days_delayed }} días de atraso
                            </small>
                            <a href="{% url 'review_delay_justification' delay.id %}" class="btn btn-warning btn-sm">
                                <i class="bi bi-clipboard-check"></i> Revisar Ahora
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Formulario de Propuesta (Solo para OFICIO) -->
            {% if is_oficio and job.status == 'OPEN' %}
            <div class="proposal-form mt-4">
                {% if user_bid %}
                    <h4 class="mb-3">
                        <i class="bi bi-pencil-square text-primary"></i> Mejorar mi Propuesta
                    </h4>
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> Ya has enviado una propuesta. Puedes actualizarla aquí.
                    </div>
                {% else %}
                    <h4 class="mb-3">
                        <i class="bi bi-send text-primary"></i> Enviar Propuesta
                    </h4>
                {% endif %}
                
                <form method="post" action="{% url 'submit_bid' job.id %}">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="amount_ars" class="form-label fw-semibold">
                            Monto de tu Oferta (ARS) <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" 
                                   class="form-control" 
                                   id="amount_ars" 
                                   name="amount_ars" 
                                   step="0.01" 
                                   min="0.01" 
                                   required
                                   value="{% if user_bid %}{{ user_bid.amount_ars }}{% endif %}"
                                   placeholder="Ej: 150000">
                            <span class="input-group-text">ARS</span>
                        </div>
                        <small class="text-muted">
                            Presupuesto base: ${{ job.budget_base_ars|floatformat:0 }} ARS
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="estimated_days" class="form-label fw-semibold">
                            Días Estimados <span class="text-danger">*</span>
                        </label>
                        <input type="number" 
                               class="form-control" 
                               id="estimated_days" 
                               name="estimated_days" 
                               min="1" 
                               required
                               value="{% if user_bid %}{{ user_bid.estimated_days }}{% endif %}"
                               placeholder="Ej: 15">
                        <small class="text-muted">
                            Tiempo estimado para completar el trabajo
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="pitch_text" class="form-label fw-semibold">
                            Tu Propuesta <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" 
                                  id="pitch_text" 
                                  name="pitch_text" 
                                  rows="6" 
                                  required
                                  placeholder="Describe tu experiencia, metodología y por qué eres la mejor opción para este trabajo...">{% if user_bid %}{{ user_bid.pitch_text }}{% endif %}</textarea>
                        <small class="text-muted">
                            Explica cómo abordarás el proyecto y qué valor aportarás
                        </small>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        {% if user_bid %}
                            <button type="submit" class="btn btn-gradient btn-lg">
                                <i class="bi bi-arrow-repeat"></i> Actualizar Propuesta
                            </button>
                        {% else %}
                            <button type="submit" class="btn btn-gradient btn-lg">
                                <i class="bi bi-send-fill"></i> Enviar Propuesta
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
        
        <!-- Columna Lateral -->
        <div class="col-lg-4">
            <!-- Información General -->
            <div class="info-card mb-4">
                <h5 class="mb-3">
                    <i class="bi bi-info-circle text-primary"></i> Información General
                </h5>
                
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Estado</small>
                    {% if job.status == 'OPEN' %}
                        <span class="badge badge-open">
                            <i class="bi bi-unlock-fill"></i> Abierto para Propuestas
                        </span>
                    {% elif job.status == 'IN_PROGRESS' %}
                        <span class="badge badge-progress">
                            <i class="bi bi-hourglass-split"></i> En Progreso
                        </span>
                    {% else %}
                        <span class="badge badge-closed">
                            <i class="bi bi-lock-fill"></i> Cerrado
                        </span>
                    {% endif %}
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Cliente</small>
                    <div class="d-flex align-items-center">
                        <div class="professional-avatar me-2" style="width: 35px; height: 35px; font-size: 0.9rem;">
                            {{ job.creator.user.first_name|first|default:"U"|upper }}{{ job.creator.user.last_name|first|default:""|upper }}
                        </div>
                        <div>
                            <div class="fw-semibold">{{ job.creator.nombre_completo }}</div>
                            <small class="text-muted">{{ job.creator.get_tipo_rol_display }}</small>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Publicado</small>
                    <div>
                        <i class="bi bi-calendar3"></i> {{ job.created_at|date:"d/m/Y H:i" }}
                    </div>
                </div>
                
                <div>
                    <small class="text-muted d-block mb-1">Última actualización</small>
                    <div>
                        <i class="bi bi-clock-history"></i> {{ job.updated_at|timesince }} atrás
                    </div>
                </div>
            </div>
            
            <!-- Estadísticas -->
            <div class="info-card mb-4">
                <h5 class="mb-3">
                    <i class="bi bi-bar-chart text-primary"></i> Estadísticas
                </h5>
                
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="stat-box">
                            <div class="stat-number">{{ bids.count }}</div>
                            <small class="text-muted">Propuesta{{ bids.count|pluralize }}</small>
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="stat-box">
                            <div class="stat-number">
                                {% if bids %}
                                    ${{ avg_bid_amount|floatformat:0 }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                            <small class="text-muted">Promedio (ARS)</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Acciones -->
            <div class="info-card">
                <h5 class="mb-3">
                    <i class="bi bi-lightning text-primary"></i> Acciones
                </h5>
                
                <div class="d-grid gap-2">
                    {% if job.status == 'IN_PROGRESS' %}
                        <a href="{% url 'job_tracking' job.id %}" class="btn btn-gradient">
                            <i class="bi bi-graph-up-arrow"></i> Ver Seguimiento Detallado
                        </a>
                        
                        {% if is_owner %}
                            <!-- Botón para confirmar inicio de obra (libera 30%) -->
                            {% if not initial_release_exists %}
                                <form method="post" action="{% url 'confirm_work_start' job.id %}" onsubmit="return confirm('¿Confirmar que la obra ha comenzado? Esto liberará el 30% (${{ job.get_winning_bid.amount_usdc|mul:0.30|floatformat:2 }} USDC) al profesional.');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-circle"></i> Confirmar Inicio de Obra (Libera 30%)
                                    </button>
                                </form>
                            {% elif not final_release_exists %}
                                <!-- Botón para finalizar obra (libera 70% - 5%) -->
                                <form method="post" action="{% url 'complete_work' job.id %}" onsubmit="return confirm('¿Confirmar que la obra está finalizada? Esto liberará el 70% restante (menos comisión del 5%) al profesional y cerrará el trabajo.');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-all"></i> Finalizar Obra (Libera 70% - 5% comisión)
                                    </button>
                                </form>
                            {% else %}
                                <div class="alert alert-success mb-0">
                                    <i class="bi bi-check-circle-fill"></i> Obra finalizada y pagada
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                    
                    <a href="{% url 'job_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver a la Lista
                    </a>
                    
                    {% if is_owner %}
                        <a href="{% url 'edit_job' job.id %}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil"></i> Editar Oferta
                        </a>
                    {% endif %}
                    
                    <button class="btn btn-outline-info" onclick="window.print()">
                        <i class="bi bi-printer"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
