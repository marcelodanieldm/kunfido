{% extends 'base.html' %}

{% block title %}Justificar Atraso - {{ job.title }} - Kunfido{% endblock %}

{% block extra_css %}
<style>
    .delay-alert {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .justification-form {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    
    .info-box {
        background: #f8f9fa;
        border-left: 4px solid var(--primary-color);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
    
    .warning-box {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container main-content">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Alerta de Atraso -->
            <div class="delay-alert">
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle-fill display-3 mb-3"></i>
                    <h2 class="mb-3">Trabajo con Atraso Detectado</h2>
                    <h4>{{ days_delayed }} día{{ days_delayed|pluralize }} de atraso</h4>
                    <p class="mb-0 opacity-75">Ejercita tu derecho a réplica justificando el atraso</p>
                </div>
            </div>
            
            <!-- Información del Trabajo -->
            <div class="info-box">
                <h5 class="mb-3">
                    <i class="bi bi-briefcase text-primary"></i> Información del Trabajo
                </h5>
                <p class="mb-2"><strong>Oferta:</strong> {{ job.title }}</p>
                <p class="mb-2"><strong>Cliente:</strong> {{ job.creator.nombre_completo }}</p>
                <p class="mb-2"><strong>Fecha de Inicio:</strong> {{ job.start_confirmed_date|date:"d/m/Y H:i" }}</p>
                <p class="mb-2"><strong>Fecha Esperada de Finalización:</strong> {{ job.expected_completion_date|date:"d/m/Y H:i" }}</p>
                <p class="mb-0"><strong>Días Estimados Originales:</strong> {{ bid.estimated_days }}</p>
            </div>
            
            {% if existing_justification %}
            <!-- Ya existe una justificación pendiente -->
            <div class="warning-box">
                <h5 class="mb-2">
                    <i class="bi bi-clock-history"></i> Justificación Pendiente de Revisión
                </h5>
                <p class="mb-2">Ya has enviado una justificación que está esperando la revisión del cliente.</p>
                <p class="mb-3"><strong>Justificación enviada:</strong></p>
                <div style="background: white; padding: 1rem; border-radius: 8px;">
                    <p class="mb-0" style="white-space: pre-wrap;">{{ existing_justification.reason }}</p>
                </div>
                <hr>
                <p class="mb-0">
                    <small class="text-muted">
                        <i class="bi bi-calendar3"></i> Enviado el {{ existing_justification.created_at|date:"d/m/Y H:i" }}
                    </small>
                </p>
            </div>
            
            <div class="text-center mt-4">
                <a href="{% url 'job_detail' job.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver al Trabajo
                </a>
            </div>
            {% else %}
            <!-- Formulario de Justificación -->
            <div class="justification-form">
                <h4 class="mb-4">
                    <i class="bi bi-pen text-primary"></i> Derecho a Réplica
                </h4>
                
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Importante:</strong> Explica de manera clara y detallada las razones del atraso. 
                    El cliente revisará tu justificación y decidirá si acepta o rechaza el atraso. 
                    Si es aceptado, no se aplicará penalización a tu puntaje.
                </div>
                
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label for="reason" class="form-label fw-semibold">
                            Justificación del Atraso <span class="text-danger">*</span>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="reason" 
                            name="reason" 
                            rows="10" 
                            required
                            minlength="50"
                            placeholder="Explica detalladamente las razones del atraso. Sé específico y honesto. Incluye cualquier circunstancia imprevista, problemas técnicos, o situaciones que hayan afectado tu capacidad de cumplir con el plazo acordado.&#10;&#10;Mínimo 50 caracteres."
                        ></textarea>
                        <div class="form-text">
                            Mínimo 50 caracteres. Sé claro y específico en tu explicación.
                        </div>
                    </div>
                    
                    <div class="warning-box mb-4">
                        <h6 class="mb-2">
                            <i class="bi bi-shield-exclamation"></i> Consecuencias
                        </h6>
                        <ul class="mb-0">
                            <li>Si el cliente <strong>acepta</strong> tu justificación: No se aplicará penalización</li>
                            <li>Si el cliente <strong>rechaza</strong> tu justificación: Se aplicará penalización de puntaje</li>
                            <li>Días de atraso actuales: <strong>{{ days_delayed }}</strong></li>
                            <li>Penalización potencial: <strong>{{ days_delayed|floatformat:1 }} puntos</strong></li>
                        </ul>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                        <a href="{% url 'job_detail' job.id %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-gradient btn-lg">
                            <i class="bi bi-send-fill"></i> Enviar Justificación
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
