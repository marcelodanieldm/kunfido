{% extends "base.html" %}

{% block title %}Dashboard - Kunfido{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        height: 100%;
        overflow: hidden;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .metric-card-header {
        padding: 1.5rem;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .metric-icon {
        font-size: 2.5rem;
        width: 70px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 15px;
        margin-bottom: 1rem;
    }
    
    .metric-icon.success {
        background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
        color: #155724;
    }
    
    .metric-icon.info {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #004085;
    }
    
    .metric-icon.warning {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #856404;
    }
    
    .metric-icon.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    
    .welcome-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .role-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: rgba(255,255,255,0.2);
        border-radius: 25px;
        font-size: 0.875rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }
    
    .quick-action-btn {
        border-radius: 10px;
        padding: 1rem;
        border: 2px dashed #dee2e6;
        text-decoration: none;
        display: block;
        text-align: center;
        transition: all 0.3s ease;
        color: #495057;
    }
    
    .quick-action-btn:hover {
        border-color: #667eea;
        background: #f8f9fa;
        color: #667eea;
        transform: translateY(-2px);
    }
    
    .recent-activity-item {
        border-left: 3px solid #667eea;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
        border-radius: 0 10px 10px 0;
    }
    
    /* Estilos para trabajos atrasados */
    .delay-card {
        border: none;
        border-radius: 15px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        box-shadow: 0 5px 20px rgba(255, 107, 107, 0.3);
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
    }
    
    .delay-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
    }
    
    .delay-badge {
        background: rgba(255, 255, 255, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        display: inline-block;
    }
    
    .on-time-card {
        border: none;
        border-radius: 15px;
        background: white;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }
    
    /* Bot√≥n especial para explicar demora */
    .delay-card .btn-light {
        background: white;
        border: none;
        color: #dc3545;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }
    
    .delay-card .btn-light:hover {
        background: #fff;
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        color: #c82333;
    }
    
    /* Notificaci√≥n flotante */
    .floating-notification {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1050;
        max-width: 400px;
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: slideInRight 0.5s ease, pulse 2s infinite;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        50% {
            box-shadow: 0 10px 40px rgba(252, 182, 159, 0.6);
        }
    }
    
    .notification-header {
        background: rgba(255, 255, 255, 0.3);
        padding: 1rem 1.5rem;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .notification-body {
        padding: 1.5rem;
    }
    
    .notification-item {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }
    
    .notification-item:last-child {
        margin-bottom: 0;
    }
    
    .close-notification {
        background: rgba(0,0,0,0.2);
        border: none;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .close-notification:hover {
        background: rgba(0,0,0,0.4);
        transform: rotate(90deg);
    }
</style>
{% endblock %}

{% block content %}
<!-- Notificaci√≥n flotante para CLIENTE con r√©plicas pendientes -->
{% if user.profile.tipo_rol in 'PERSONA,CONSORCIO' and cantidad_replicas_pendientes > 0 %}
<div class="floating-notification" id="replicasNotification">
    <div class="notification-header">
        <div class="flex-grow-1">
            <h5 class="mb-0 fw-bold">
                <i class="bi bi-bell-fill"></i> 
                R√©plicas Pendientes ({{ cantidad_replicas_pendientes }})
            </h5>
        </div>
        <button class="close-notification ms-2" onclick="document.getElementById('replicasNotification').style.display='none'">
            <i class="bi bi-x"></i>
        </button>
    </div>
    <div class="notification-body">
        <p class="mb-3 small">
            <i class="bi bi-info-circle"></i> 
            Tienes justificaciones de atraso esperando tu respuesta
        </p>
        {% for replica in replicas_pendientes|slice:":3" %}
        <div class="notification-item">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <strong class="d-block mb-1">{{ replica.oferta.titulo|truncatewords:5 }}</strong>
                    <small class="text-muted d-block mb-1">
                        <i class="bi bi-person"></i> {{ replica.profesional.get_full_name|default:replica.profesional.username }}
                    </small>
                    <small class="text-danger">
                        <i class="bi bi-clock"></i> {{ replica.dias_atraso_justificados }} d√≠as de atraso
                    </small>
                </div>
                <a href="{% url 'usuarios:job_detail_private' replica.oferta.id %}" 
                   class="btn btn-sm btn-gradient">
                    Ver
                </a>
            </div>
        </div>
        {% endfor %}
        
        {% if cantidad_replicas_pendientes > 3 %}
        <div class="text-center mt-3">
            <small class="text-muted">
                Y {{ cantidad_replicas_pendientes|add:"-3" }} m√°s...
            </small>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<div class="container py-4">
    <!-- Welcome Card -->
    <div class="welcome-card">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold mb-2">
                    ¬°Hola, {{ user.get_full_name|default:user.username }}! üëã
                </h1>
                <p class="mb-2 fs-5">Bienvenido a tu panel de control</p>
                <div class="role-badge">
                    {% if user.profile.tipo_rol == 'PERSONA' %}
                        <i class="bi bi-person-circle"></i> Persona
                    {% elif user.profile.tipo_rol == 'CONSORCIO' %}
                        <i class="bi bi-building"></i> Consorcio
                    {% elif user.profile.tipo_rol == 'OFICIO' %}
                        <i class="bi bi-tools"></i> Oficio
                    {% endif %}
                    {% if user.profile.zona %}
                        | <i class="bi bi-geo-alt-fill"></i> {{ user.profile.zona }}
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4 text-center text-md-end">
                <div class="fs-1">‚≠ê</div>
                <div class="fs-3 fw-bold">{{ user.profile.puntuacion|floatformat:1 }}</div>
                <div class="small">Tu Puntuaci√≥n</div>
            </div>
        </div>
    </div>

    <!-- M√©tricas seg√∫n el rol -->
    {% if user.profile.tipo_rol == 'OFICIO' %}
        <!-- Dashboard para OFICIO -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon success mx-auto">
                            <i class="bi bi-trophy-fill"></i>
                        </div>
                        <div class="metric-value text-success">24</div>
                        <div class="metric-label">Trabajos Ganados</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon info mx-auto">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="metric-value text-info">8</div>
                        <div class="metric-label">En Progreso</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon warning mx-auto">
                            <i class="bi bi-inbox-fill"></i>
                        </div>
                        <div class="metric-value text-warning">12</div>
                        <div class="metric-label">Propuestas Enviadas</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon primary mx-auto">
                            <i class="bi bi-cash-stack"></i>
                        </div>
                        <div class="metric-value text-primary">$45.8K</div>
                        <div class="metric-label">Ingresos Totales</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n Mis Compromisos para OFICIO -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-clipboard-check"></i> Mis Compromisos
                        </h5>
                        <span class="badge bg-primary">{{ total_compromisos }} activos</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trabajos Atrasados -->
        {% if trabajos_atrasados %}
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="text-danger mb-3">
                    <i class="bi bi-exclamation-triangle-fill"></i> 
                    Trabajos con Atraso ({{ trabajos_atrasados|length }})
                </h6>
            </div>
            {% for trabajo in trabajos_atrasados %}
            <div class="col-md-6 col-lg-4">
                <div class="delay-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="fw-bold mb-0">{{ trabajo.titulo|truncatewords:6 }}</h6>
                            <span class="delay-badge">
                                <i class="bi bi-clock"></i> {{ trabajo.dias_atraso }} d√≠as
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <small class="d-block opacity-75">
                                <i class="bi bi-person"></i> 
                                {{ trabajo.creador.get_full_name|default:trabajo.creador.username }}
                            </small>
                            <small class="d-block opacity-75">
                                <i class="bi bi-geo-alt"></i> {{ trabajo.zona }}
                            </small>
                            {% if trabajo.fecha_entrega_pactada %}
                            <small class="d-block opacity-75">
                                <i class="bi bi-calendar-x"></i> 
                                Entrega: {{ trabajo.fecha_entrega_pactada|date:"d/m/Y" }}
                            </small>
                            {% endif %}
                        </div>

                        {% if trabajo.justificacion_existente %}
                            <!-- Ya tiene justificaci√≥n -->
                            <div class="alert alert-light mb-3 py-2 px-3">
                                <small>
                                    <i class="bi bi-info-circle"></i>
                                    {% if trabajo.justificacion_existente.penalizacion_omitida %}
                                        <strong class="text-success">‚úì Justificaci√≥n aceptada</strong>
                                    {% else %}
                                        <strong class="text-warning">‚è≥ Justificaci√≥n pendiente</strong>
                                    {% endif %}
                                </small>
                            </div>
                            <a href="{% url 'usuarios:crear_justificacion_atraso' trabajo.id %}" 
                               class="btn btn-light btn-sm w-100">
                                <i class="bi bi-pencil"></i> Actualizar Justificaci√≥n
                            </a>
                        {% else %}
                            <!-- No tiene justificaci√≥n -->
                            <a href="{% url 'usuarios:crear_justificacion_atraso' trabajo.id %}" 
                               class="btn btn-light btn-lg w-100 fw-bold">
                                <i class="bi bi-chat-left-text-fill"></i> Explicar Demora
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Trabajos al D√≠a -->
        {% if trabajos_al_dia %}
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="text-success mb-3">
                    <i class="bi bi-check-circle-fill"></i> 
                    Trabajos al D√≠a ({{ trabajos_al_dia|length }})
                </h6>
            </div>
            {% for trabajo in trabajos_al_dia %}
            <div class="col-md-6 col-lg-4">
                <div class="on-time-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="fw-bold mb-0">{{ trabajo.titulo|truncatewords:6 }}</h6>
                            <span class="badge bg-success">
                                <i class="bi bi-check"></i> Al d√≠a
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted d-block">
                                <i class="bi bi-person"></i> 
                                {{ trabajo.creador.get_full_name|default:trabajo.creador.username }}
                            </small>
                            <small class="text-muted d-block">
                                <i class="bi bi-geo-alt"></i> {{ trabajo.zona }}
                            </small>
                            {% if trabajo.fecha_entrega_pactada %}
                            <small class="text-muted d-block">
                                <i class="bi bi-calendar-check"></i> 
                                Entrega: {{ trabajo.fecha_entrega_pactada|date:"d/m/Y" }}
                            </small>
                            {% endif %}
                        </div>

                        <a href="{% url 'usuarios:job_detail_public' trabajo.id %}" 
                           class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-eye"></i> Ver Detalles
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if not trabajos_atrasados and not trabajos_al_dia %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card text-center py-5">
                    <div class="card-body">
                        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-muted">No tienes compromisos activos</h5>
                        <p class="text-muted">
                            Comienza a enviar propuestas para ganar trabajos
                        </p>
                        <a href="{% url 'usuarios:public_feed' %}" class="btn btn-gradient mt-2">
                            <i class="bi bi-search"></i> Buscar Trabajos
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Secci√≥n de acciones r√°pidas para OFICIO -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-list-task"></i> Trabajos Recientes</h5>
                    </div>
                    <div class="card-body">
                        <div class="recent-activity-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Reparaci√≥n de Plomer√≠a - Edificio Central</h6>
                                    <small class="text-muted">Completado hace 2 d√≠as</small>
                                </div>
                                <span class="badge bg-success">Finalizado</span>
                            </div>
                        </div>
                        <div class="recent-activity-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Instalaci√≥n El√©ctrica - Departamento 5B</h6>
                                    <small class="text-muted">En progreso</small>
                                </div>
                                <span class="badge bg-warning">En Curso</span>
                            </div>
                        </div>
                        <div class="recent-activity-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Pintura General - Casa Particular</h6>
                                    <small class="text-muted">Propuesta enviada</small>
                                </div>
                                <span class="badge bg-info">Pendiente</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-lightning-fill"></i> Acciones R√°pidas</h5>
                    </div>
                    <div class="card-body">
                        <a href="#" class="quick-action-btn mb-3">
                            <i class="bi bi-search fs-4"></i>
                            <div class="mt-2 fw-bold">Buscar Trabajos</div>
                        </a>
                        <a href="#" class="quick-action-btn mb-3">
                            <i class="bi bi-file-earmark-text fs-4"></i>
                            <div class="mt-2 fw-bold">Mis Propuestas</div>
                        </a>
                        <a href="#" class="quick-action-btn">
                            <i class="bi bi-gear fs-4"></i>
                            <div class="mt-2 fw-bold">Configuraci√≥n</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

    {% elif user.profile.tipo_rol == 'CONSORCIO' %}
        <!-- Dashboard para CONSORCIO -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon success mx-auto">
                            <i class="bi bi-building-fill"></i>
                        </div>
                        <div class="metric-value text-success">15</div>
                        <div class="metric-label">Obras en el Edificio</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon info mx-auto">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <div class="metric-value text-info">32</div>
                        <div class="metric-label">Obras Completadas</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon warning mx-auto">
                            <i class="bi bi-bell-fill"></i>
                        </div>
                        <div class="metric-value text-warning">{{ cantidad_replicas_pendientes|default:0 }}</div>
                        <div class="metric-label">R√©plicas Pendientes</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon primary mx-auto">
                            <i class="bi bi-cash-coin"></i>
                        </div>
                        <div class="metric-value text-primary">$125K</div>
                        <div class="metric-label">Presupuesto Mensual</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- R√©plicas Pendientes para CONSORCIO -->
        {% if replicas_pendientes %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle-fill"></i> 
                            Justificaciones de Atraso Pendientes ({{ cantidad_replicas_pendientes }})
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            Los siguientes profesionales han enviado justificaciones por atrasos en obras del edificio. 
                            Revisa y decide si aceptas o rechazas cada explicaci√≥n.
                        </p>
                        
                        {% for replica in replicas_pendientes %}
                        <div class="alert alert-light border-start border-warning border-4 mb-3">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-2">
                                        <i class="bi bi-building-gear"></i> {{ replica.oferta.titulo }}
                                    </h6>
                                    <p class="mb-2 small">
                                        <strong>
                                            <i class="bi bi-person"></i> 
                                            {{ replica.profesional.get_full_name|default:replica.profesional.username }}
                                        </strong>
                                    </p>
                                    <p class="mb-2 small text-danger">
                                        <i class="bi bi-clock"></i> 
                                        <strong>{{ replica.dias_atraso_justificados }} d√≠as de atraso</strong>
                                    </p>
                                    <p class="mb-2 small text-muted">
                                        <i class="bi bi-chat-left-quote"></i> 
                                        {{ replica.replica|truncatewords:20 }}
                                    </p>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> 
                                        Enviado el {{ replica.fecha_creacion|date:"d/m/Y H:i" }}
                                    </small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <a href="{% url 'usuarios:job_detail_private' replica.oferta.id %}" 
                                       class="btn btn-primary mb-2 w-100">
                                        <i class="bi bi-eye"></i> Ver Detalles Completos
                                    </a>
                                    <form method="post" action="{% url 'usuarios:aceptar_replica_atraso' replica.id %}" class="d-inline w-100">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success mb-2 w-100">
                                            <i class="bi bi-check-circle"></i> Aceptar Justificaci√≥n
                                        </button>
                                    </form>
                                    <form method="post" action="{% url 'usuarios:rechazar_replica_atraso' replica.id %}" class="d-inline w-100">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-danger w-100">
                                            <i class="bi bi-x-circle"></i> Rechazar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Secci√≥n de acciones r√°pidas para CONSORCIO -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-building-gear"></i> Obras Recientes del Edificio</h5>
                    </div>
                    <div class="card-body">
                        <div class="recent-activity-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Mantenimiento de Ascensores</h6>
                                    <small class="text-muted">Iniciado hace 1 semana</small>
                                </div>
                                <span class="badge bg-warning">En Progreso</span>
                            </div>
                        </div>
                        <div class="recent-activity-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Pintura de Fachada</h6>
                                    <small class="text-muted">Planificado para pr√≥ximo mes</small>
                                </div>
                                <span class="badge bg-info">Planificado</span>
                            </div>
                        </div>
                        <div class="recent-activity-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Reparaci√≥n de Tanque de Agua</h6>
                                    <small class="text-muted">Completado hace 3 d√≠as</small>
                                </div>
                                <span class="badge bg-success">Completado</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-lightning-fill"></i> Acciones R√°pidas</h5>
                    </div>
                    <div class="card-body">
                        <a href="#" class="quick-action-btn mb-3">
                            <i class="bi bi-plus-circle fs-4"></i>
                            <div class="mt-2 fw-bold">Nueva Obra</div>
                        </a>
                        <a href="#" class="quick-action-btn mb-3">
                            <i class="bi bi-people fs-4"></i>
                            <div class="mt-2 fw-bold">Gestionar Proveedores</div>
                        </a>
                        <a href="#" class="quick-action-btn">
                            <i class="bi bi-file-earmark-bar-graph fs-4"></i>
                            <div class="mt-2 fw-bold">Ver Reportes</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

    {% elif user.profile.tipo_rol == 'PERSONA' %}
        <!-- Dashboard para PERSONA -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon success mx-auto">
                            <i class="bi bi-clipboard-check-fill"></i>
                        </div>
                        <div class="metric-value text-success">7</div>
                        <div class="metric-label">Servicios Solicitados</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon info mx-auto">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                        <div class="metric-value text-info">3</div>
                        <div class="metric-label">En Proceso</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon warning mx-auto">
                            <i class="bi bi-bell-fill"></i>
                        </div>
                        <div class="metric-value text-warning">{{ cantidad_replicas_pendientes|default:0 }}</div>
                        <div class="metric-label">R√©plicas Pendientes</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div class="metric-icon primary mx-auto">
                            <i class="bi bi-house-heart-fill"></i>
                        </div>
                        <div class="metric-value text-primary">$8.5K</div>
                        <div class="metric-label">Gastado en Servicios</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- R√©plicas Pendientes -->
        {% if replicas_pendientes %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle-fill"></i> 
                            Justificaciones de Atraso Pendientes ({{ cantidad_replicas_pendientes }})
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            Los siguientes profesionales han enviado justificaciones por atrasos. 
                            Revisa y decide si aceptas o rechazas cada explicaci√≥n.
                        </p>
                        
                        {% for replica in replicas_pendientes %}
                        <div class="alert alert-light border-start border-warning border-4 mb-3">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-2">
                                        <i class="bi bi-briefcase"></i> {{ replica.oferta.titulo }}
                                    </h6>
                                    <p class="mb-2 small">
                                        <strong>
                                            <i class="bi bi-person"></i> 
                                            {{ replica.profesional.get_full_name|default:replica.profesional.username }}
                                        </strong>
                                    </p>
                                    <p class="mb-2 small text-danger">
                                        <i class="bi bi-clock"></i> 
                                        <strong>{{ replica.dias_atraso_justificados }} d√≠as de atraso</strong>
                                    </p>
                                    <p class="mb-2 small text-muted">
                                        <i class="bi bi-chat-left-quote"></i> 
                                        {{ replica.replica|truncatewords:20 }}
                                    </p>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> 
                                        Enviado el {{ replica.fecha_creacion|date:"d/m/Y H:i" }}
                                    </small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <a href="{% url 'usuarios:job_detail_private' replica.oferta.id %}" 
                                       class="btn btn-primary mb-2 w-100">
                                        <i class="bi bi-eye"></i> Ver Detalles Completos
                                    </a>
                                    <form method="post" action="{% url 'usuarios:aceptar_replica_atraso' replica.id %}" class="d-inline w-100">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success mb-2 w-100">
                                            <i class="bi bi-check-circle"></i> Aceptar Justificaci√≥n
                                        </button>
                                    </form>
                                    <form method="post" action="{% url 'usuarios:rechazar_replica_atraso' replica.id %}" class="d-inline w-100">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-danger w-100">
                                            <i class="bi bi-x-circle"></i> Rechazar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Secci√≥n de acciones r√°pidas para PERSONA -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Actividad Reciente</h5>
                    </div>
                    <div class="card-body">
                        <div class="recent-activity-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Reparaci√≥n de Aire Acondicionado</h6>
                                    <small class="text-muted">Completado hace 1 d√≠a</small>
                                </div>
                                <span class="badge bg-success">Finalizado</span>
                            </div>
                        </div>
                        <div class="recent-activity-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Instalaci√≥n de Ventilador de Techo</h6>
                                    <small class="text-muted">Esperando presupuestos</small>
                                </div>
                                <span class="badge bg-warning">Pendiente</span>
                            </div>
                        </div>
                        <div class="recent-activity-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Limpieza Profunda</h6>
                                    <small class="text-muted">Programado para ma√±ana</small>
                                </div>
                                <span class="badge bg-info">Pr√≥ximo</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-lightning-fill"></i> Acciones R√°pidas</h5>
                    </div>
                    <div class="card-body">
                        <a href="#" class="quick-action-btn mb-3">
                            <i class="bi bi-plus-circle fs-4"></i>
                            <div class="mt-2 fw-bold">Nuevo Servicio</div>
                        </a>
                        <a href="#" class="quick-action-btn mb-3">
                            <i class="bi bi-search fs-4"></i>
                            <div class="mt-2 fw-bold">Buscar Profesionales</div>
                        </a>
                        <a href="#" class="quick-action-btn">
                            <i class="bi bi-star fs-4"></i>
                            <div class="mt-2 fw-bold">Mis Favoritos</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Si no tiene rol asignado -->
        <div class="row">
            <div class="col-12">
                <div class="card text-center p-5">
                    <div class="card-body">
                        <i class="bi bi-info-circle text-warning" style="font-size: 4rem;"></i>
                        <h3 class="mt-3">Perfil Incompleto</h3>
                        <p class="text-muted mb-4">
                            Para acceder a todas las funcionalidades, por favor selecciona tu tipo de perfil
                        </p>
                        <a href="{% url 'usuarios:onboarding_rol' %}" class="btn btn-gradient btn-lg">
                            <i class="bi bi-stars"></i> Completar Perfil
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Secci√≥n de Wallet y Transacciones (para todos los usuarios) -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card metric-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-body text-center">
                    <h5 class="mb-3">
                        <i class="bi bi-wallet2"></i> Mi Billetera
                    </h5>
                    <div style="font-size: 3rem; font-weight: 700; margin: 1.5rem 0;">
                        {{ wallet.balance_usdc|floatformat:2 }}
                    </div>
                    <div style="opacity: 0.9; font-size: 1.1rem;">
                        USDC_MOCK
                    </div>
                    <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(255,255,255,0.15); border-radius: 8px;">
                        <i class="bi bi-arrow-left-right" style="font-size: 0.8rem;"></i>
                        <span style="font-size: 1.2rem; font-weight: 600;">‚âà ${{ wallet_balance_ars|floatformat:2 }} ARS</span>
                        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">
                            D√≥lar Blue: ${{ exchange_rate_blue|floatformat:2 }}
                        </div>
                    </div>
                    <hr style="border-color: rgba(255,255,255,0.3); margin: 1.5rem 0;">
                    <div class="text-start" style="font-size: 0.875rem; opacity: 0.9;">
                        <div class="mb-2">
                            <i class="bi bi-clock-history"></i> 
                            Actualizado: {{ wallet.fecha_actualizacion|date:"d/m/Y H:i" }}
                        </div>
                        <div>
                            <i class="bi bi-shield-check"></i> 
                            Cuenta {{ wallet.get_tipo_cuenta_display }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Transacciones Recientes
                    </h5>
                    <small class="text-muted">√öltimos 10 movimientos</small>
                </div>
                <div class="card-body" style="max-height: 450px; overflow-y: auto;">
                    {% if transacciones %}
                        {% for trans in transacciones %}
                            <div class="transaction-item" style="padding: 1rem; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;">
                                <div class="row align-items-center">
                                    <div class="col-md-7">
                                        <div class="d-flex align-items-start gap-3">
                                            <!-- Icono seg√∫n tipo de transacci√≥n -->
                                            <div style="width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;
                                                {% if trans.tipo_transaccion == 'ESCROW_DEPOSIT' %}
                                                    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
                                                {% elif trans.tipo_transaccion == 'RELEASE_PAYMENT' %}
                                                    background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
                                                {% elif trans.tipo_transaccion == 'REFUND' %}
                                                    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
                                                {% elif trans.tipo_transaccion == 'FEE' %}
                                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
                                                {% else %}
                                                    background: #e9ecef;
                                                {% endif %}">
                                                {% if trans.tipo_transaccion == 'ESCROW_DEPOSIT' %}
                                                    <i class="bi bi-lock-fill"></i>
                                                {% elif trans.tipo_transaccion == 'RELEASE_PAYMENT' %}
                                                    <i class="bi bi-unlock-fill"></i>
                                                {% elif trans.tipo_transaccion == 'REFUND' %}
                                                    <i class="bi bi-arrow-counterclockwise"></i>
                                                {% elif trans.tipo_transaccion == 'FEE' %}
                                                    <i class="bi bi-percent"></i>
                                                {% else %}
                                                    <i class="bi bi-arrow-left-right"></i>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="flex-grow-1">
                                                <div class="fw-bold mb-1">
                                                    {{ trans.get_tipo_transaccion_display }}
                                                </div>
                                                <small class="text-muted d-block mb-1">
                                                    {{ trans.descripcion|truncatewords:10 }}
                                                </small>
                                                {% if trans.oferta_relacionada %}
                                                    <small class="text-primary">
                                                        <i class="bi bi-briefcase"></i> 
                                                        {{ trans.oferta_relacionada.titulo|truncatewords:4 }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3 text-center">
                                        <div class="fw-bold" style="font-size: 1.25rem;
                                            {% if trans.from_wallet == wallet %}
                                                color: #dc3545;
                                            {% else %}
                                                color: #28a745;
                                            {% endif %}">
                                            {% if trans.from_wallet == wallet %}
                                                - {{ trans.monto_usdc }}
                                            {% else %}
                                                + {{ trans.monto_usdc }}
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">USDC</small>
                                    </div>
                                    
                                    <div class="col-md-2 text-end">
                                        <span class="badge 
                                            {% if trans.status == 'COMPLETED' %}
                                                bg-success
                                            {% elif trans.status == 'PENDING' %}
                                                bg-warning
                                            {% elif trans.status == 'FAILED' %}
                                                bg-danger
                                            {% else %}
                                                bg-secondary
                                            {% endif %}" style="font-size: 0.75rem;">
                                            {{ trans.get_status_display }}
                                        </span>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                {{ trans.fecha_creacion|date:"d/m H:i" }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                            <p class="text-muted mt-3">No tienes transacciones a√∫n</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}
